# 更新履歴

## [Unreleased]
### jinroプラグイン
- Buttonオブジェクトにclickse, enterseプロパティを追加
- CLASS_BUTTON_SE_HOVER定数を削除

### ボイボ人狼
#### SE
- SEのうち、効果音はbuf="0", ボイスはbuf="1"で鳴らすよう統一
- [glink][button]のclickse, enterseパラメータを利用してボタン用SEを鳴らすように統一
  - jQueryでボタンホバー時にplayseタグを実行してSEを鳴らす処理は撤廃。
    - おそらくこれが「マウスをホバーさせるたびにボタンが増殖する」「黒いglinkボタンが表示される」バグなどの主原因。jsでのplayseタグは非同期で実行され、[s]も突き抜けるため。
    - 「ステータス画面を開いて閉じると、スライドインや効果音が出なくなる」バグも、jsを使わなくなったことで解決した。
- fixボタンやクリッカブル領域にもボタン用SEを付与

#### バグ修正
- インストラクションにてステータス画面を表示→「もどる」→メニュー→「タイトルにもどる」と、タイトル画面に「？？？」の立ち絵が残るバグを修正
  - 原因：ステータス画面のインストラクションが終わったタイミングでf.displayedCharacter変数上は「？？？」を退場した扱いにしてしまっていたため、「タイトルにもどる」時に立ち絵を退場させられなかった

## [0.13.1] - 2025-05-01
- バージョン管理をボイボ人狼本体とjinroプラグインで別々にするように

## [0.13.0] - 2025-05-01

### バージョン管理・表示周り
- ティラノスクリプトを`v600beta5`にアップデート
- デバッグモード時はタイトル画面のバージョン表示に「デバッグモード」を明記するよう修正  

### 音声（BGM／SE／ボイス）の改善
- **ボタンホバーSE**  
  - プリロードしておき、キャラスライドイン前に再生するように  
    - 「アクションの第二階層を開いたとき、黒いglinkボタンが表示されることがある」バグに対するおまじない
  - SE 処理をメソッド／クラス化し、各ボタンに一括適用  

### UI・UX の調整
- **ウィンドウ／レイヤー管理**  
  - 全ウィンドウ表示・閉じる処理をマクロ化  
  - 各ウィンドウを適切なレイヤー（layer=1,2,3…）で表示  
- **文言・位置調整**  
  - 「遊び方」→「ヘルプ」、「リプレイ」など文言修正  
  - 各種ボタン（閉じる／開始／投票→ 等）の位置微調整  
  - タイトル画面ロゴ・ボタン位置の調整  
- **メニュー項目制御**  
  - 「視聴済みチャプター」→「視聴済みエピソード」に名称統一  

### カスタマイズ画面の新規作成
- ドラッグ＆ドロッププラグインの正式採用は保留。動作に影響がない程度に実装はコメントアウトして残す

### シアターモード／エピソード進捗
- シアター進捗の管理方法を全面変更。チャプターごとではなく、エピソードごとに進捗ステータスをもつように
  - 導入編はチャプター再生終了時に、解決編はチャプター再生開始時に進捗ステータスを進める
- エピソードオブジェクトに、エピソードの開始条件と解放条件を設定できるように
- エピソードの開始条件を満たしたら導入編（※）を、解放条件を満たしたら解決編を自動再生するように
  - タイトル画面の「解決編未解放時の導入編」ボタンで「スキップ」なら、初回解放時以外は自動再生しない
  - （※）人狼ゲーム開始時に開始条件と解放条件を通知するウィンドウを表示する
 - 進捗ステータスが「解決編まで解放済み」ではない場合、開始条件と解放条件はネタバレボタンを押すと確認できる仕様とする
 - チャプター再生前に共通で実行するべきマクロを作成
 - インストラクション（＝チュートリアルから改名）も、シアターも、チャプターマクロから開始するように修正
 - チャプター再生時にタイトルカットインを表示するように
  - カットイン時と人狼ゲーム開始時にBGMとSEのフェードアウトをするように

### ゲームロジック・バグ修正
- **NPC 行動**  
  - 直前と同じアクションを連続実行しないように修正  
- **トリガー履歴**  
  - アクション履歴に同一トリガーを２つ格納していた問題を修正  
- **データ初期化**  
  - シチュエーション用 `JinroGameData` が null の場合でも動作するよう修正  
  - ページごとの基本人狼ゲームデータ取得関数を整備  
- **その他多数**
  - 開始条件チェック、進捗ステータス更新タイミング、スタック消失バグなど、合致チェックマクロやサブルーチン化で改善  

### キャラクター・立ち絵・プロフィール
- **立ち絵**  
  - 各キャラに新規差分を追加・位置微調整  
- **プロフィール**  
  - 「キャラ情報」→「プロフィール」に統一（ファイル名含む）  
  - 性格パラメータや文面の微修正  
- **セリフ**  
  - 各キャラにプレイヤー操作時用のセリフパターンを追加

### エピソード・インストラクション
- すべてのエピソードにボイス、BGM、SE、ボイス、立ち絵、演出の追加
- インストラクションにも追加。タイトル画面の「ヘルプ」から再生できるように

### マクロ・コード構造の整理
- 不要マクロ・コメントの削除（`selectStage.ks`、未使用マクロ等）  
- マクロ引数追加／名称変更（例：`w_closeWindow` に `waitAnime`、`m_changeFrameWithId` に画像指定引数）  
- `Episode` オブジェクトのプロパティ名改修（`unlockCondition`→`unlockConditionText` など）  
- ディレクトリ／ファイル名の統合・改名（`achievement`→`ResultCondition.js`、`introEpisode`→`IntroChapter` など）  

## [0.12.0] - 2024-09-21
- ティラノスクリプトをver525bにアップデート。
- ファイル名を英数字のみに統一。
- プレイ履歴（役職ごとの勝利回数、連勝記録）を記録できるように。
- glinkボタンの色について、「何もしない」「戻る」系のボタンも、「選択済み」と同じ色をつけるように修正。
- 人狼ゲーム関連
  - カウンターアクションのシステムを実装
    - 「喋りすぎ」のカウンターアクションを実装。各キャラにフラストレーション値を実装。
  - [j_doAction]を全面刷新
- キャラ立ち絵関連
  - 立ち絵のfaceを日本語に統一
  - [m_enterCharacter]の立ち絵反転ロジックにキャラのreflect属性を反映できるようにバグ修正。
  - [m_exitCharacter]にside属性を追加
  - キャラ立ち絵の登録処理をexecuteCharaNewFaceShowサブルーチン化して共通化。
- バグ修正
  - mac版で一部の音声が再生されないバグを修正
  - 人狼ゲーム終了後にタイトルに戻るとver表示が消えるバグを修正
  - 人狼ゲーム終了後にシアターに戻るとエピソードウィンドウが消えるバグを修正
  - ゲーム起動後にはじめてメッセージ枠を出すとき一瞬黒い枠が出ていたバグを修正
  - メッセージ枠をvisible="false"するときにf.currentFrameを初期化しておらず、次に枠を表示したときに意図しない方向にフキダシが出てしまうことがあるバグを修正
  - 一部のシアターでクリック連打すると[chara_mod]実行時にフリーズすることがあるバグが、ティラノのアップデートにより修正
  - 人狼ゲーム終了後次のゲームを開始すると、初日朝までの間役職が見えてしまうバグを修正
  - 開発者用設定の独裁者モードONのとき、シアターでも前の役職名が表示されていたバグを修正
- 各種リファクタリング

## [0.11.0] - 2024-08-12
- チュートリアル実装。初回プレイ時に強制で、シアターから任意で視聴できるように。
- タイトル画面のボタン位置と名称を修正。シアター進捗に合わせて表示するボタンを変更できるように。
- 人狼ゲーム関連
  - 人狼メニュー画面実装
    - ゲーム中は開けるが、ステータスからは開けないように変更。
  - 立ち絵表示タイミングの調整。
  - 各種メッセージの整理。無駄なメッセージを省くように。
  - 人狼ゲーム中のセリフごとに立ち絵の位置を設定できるように。襲撃時用の表情を追加。
  - プレイヤーが議論でアクション選択するとアクション予告が更新されるように修正。
  - 1期生2期生の性格を作成
  - 性格調整用オブジェクトadjustParametersで、Participant生成時の引数で性格を調整できるようにした
  - アクションによる信頼度増減処理を調整
- シアター関連
  - ポーズメニュー画面実装
  - チャプター視聴終了時に条件を満たしていたら進捗オブジェクトを解放できるように。
  - エピソード選択用画像を、進捗に合わせて金枠銀枠を表示しわけるように。
  - シアターのエピソードから人狼を始めたとき、終了時はエピソードに戻れるように修正
- キャラ立ち絵関連
  - 3,4期生のcharaサブルーチン、キャラ定数を作成
  - キャラの立ち絵の位置指定用の変数を変更。キャラ登場退場マクロの内部処理をそれに合わせて修正。
  - キャラごとのデフォルトのサイドではなく引数で選択できるようにした。
  - キャラクター登録サブルーチン修正。人狼ゲームに登場するキャラを登録する以外に、追加で登録できるサブルーチンを作成。
- バグ修正
  - 起動時、システム変数のボイス音量が適用されないバグを修正
  - 騙り占いCO時の進行不能バグを修正
  - PCが騙り占いCOをしたあと、議論のラウンド1でPCがアクションしなかった場合に騙り占いが再実行されてしまうバグを修正
  - cond属性の中で==={}でオブジェクトの要素数が0かを判定することはできない。そのように判定してしまったせいで騙り占いCOを「一つ前で戻る」でキャンセルできなくなっていたバグを修正
  - デバッグモードでないなら、NPCの投票タイミングをプレイヤーがカンニングできない位置に修正
- 各種リファクタリング

## [0.10.0] - 2024-04-30
- アチーブメント機能作成。
- コンフィグ画面作成。
  - BGM、ボイス、SEの音量調整、ミュート機能
  - テキスト速度調整機能
  - キャラ名マーカーの太さ選択機能
- PCの騙り占い結果選択時の画面構成を変更。
  - 「一つ前に戻る」ボタンを追加。
  - 「人狼だった/ではなかった」とキャラクター選択ボタンを一画面内に表示するように変更。

## [0.9.0] - 2023-08-13
- シアター画面実装。
- 人狼ゲームの初期化処理を汎用化。
- ボイスを人狼ゲーム開始時にプリロードするように修正。
- キャラクターの立ち絵、セリフの表示用マクロを改善。
  - ボイス再生のためには[playselist]プラグインが必須となる。
- 以下のバグを修正。
  - メニュー画面を開いてからステータス画面に戻ると、開票時などにバックログボタンが消えないバグ
  - 追放時のセリフ表示時にステータス画面を開くと追放結果が格納されないバグ

## [0.8.0] - 2023-05-28
- ステータス画面実装。
- バックログボタンを常時表示するように。
- メニューボタンをステータス画面でのみ表示するように。
- 占いCOメッセージ表示中にステータス画面を開くと、COしたことにならなくなるバグを修正。
- プレイヤーが退場済みでも議論フェイズにアクションボタンが表示されているバグを修正。

## [0.7.2] - 2023-05-01
- 「タイトルに戻る」後に再度プレイすると、メニューボタン等がクリックできなくなる問題を修正。
- ティラノスクリプトのデフォルトのバックログ機能を、プレイヤーに使われる前提で修正。
  - ステータス画面内に、バックログ画面を表示するためのボタンを実装（ゲーム中にマウスのホイールを上に回すことでも表示可能）。
  - バックログに記録不要なメッセージは記録しないように。
  - 投票結果をバックログに記録するように。
  - メッセージ内でキャラ名を呼称するたびにログが切れて次の行に移っていた問題を修正。
  - バックログ保存行数をデフォルトの50から200に（修正した`data/system/Config.tjs`はgit push対象外）。
  - タイトル画面でバックログをリセットするように。

## [0.7.1] - 2023-04-22
- 開発者用設定画面作成（独裁者モード、役職シャッフル、ラウンド設定、NPCの思考方針）
- 現在の変数をファイル出力する機能を追加。
- 資料置き場（docsディレクトリ）を作成。
- 不要なボタンを削除。
- 2日目以降のCO確率の調整。
- BGM,SEの演出強化。
- ステータス画面で現在のCO状況を表示できるように（アクションオブジェクトに適応）

## [0.7] - 2023-03-26
- ティラノスクリプトのバージョンをv521fに。
- ボイス実装。
- 議論フェイズでNPCがアクション対象を選択する際、同陣営割合が同値なら仲間度で決めるように修正。
- 表示キャラオブジェクトで、登場中のキャラクターの表示状態を管理するように修正。
- 昼開始時や夜開始時に必要な処理や演出をまとめてマクロ化。
  - 初日にキャラ紹介画面を表示するように。
    - 横並びでキャラクター画像を表示するサブルーチンは、ステータス画面にも使える想定。
- 視点整理（破綻）や情報公開などをするタイミングの変更。
  - 夜に占った場合の視点整理タイミングを、実際に占いCOしたタイミングに変更。
  - 騙り占いの結果は、夜ではなく昼に占いCOするタイミングで選択するよう変更。
  - 各キャラ視点で、昼の処刑対象者が人狼の最後の生存者だったのに夜時間を迎えた場合は破綻するように修正。
  - 昼時間開始の演出中に、昨夜の襲撃結果が判明し、視点整理するよう修正。
- 以下のバグを修正。
  - PCの占い対象のキャラクターが翌朝最初に発言する場合、更に左へ移動してしまうことがあるバグ
  - PCが騙り占いで破綻すると例外エラーで止まるバグ
  - ボタン表示時にカーソルが初めからボタンの位置にあると、hoverイベントが発生しないのでクラス名を取得できないバグ
  - メッセージ表示よりも早く`[playse]`（ボイス）の再生が完了すると、`[p]`で止まらず次のセリフに進んでしまうバグ

## [0.6] - 2023-02-12
- 投票結果画面をHTMLを利用した立ち絵で一覧表示できるように。
- 投票結果や占いCO結果で信頼度を増減するように。
  - 内部的には、投票や占いもアクションオブジェクトに集約し、信頼度増減処理に渡すようにした。
- アクション実行者の主張力を下げて、同日中は再発言しにくくなるように。
- ボタンのテーマを統一し、選択中やその他の理由で色を変えられるように。
  - 内部的には、ボタンオブジェクトを作成してボタン表示するように処理を統一した。
- ボタンを押されたくないタイミングでは消去するように。

## [0.5] - 2023-01-16
- 投票フェイズで同票だった場合に再投票できるように。上限を越えたら引き分けにするように。
- 議論フェイズ作成。
  - 議論によって信頼度が増減するように。
  - NPCが他キャラへの信頼度や同陣営可能性によって議論時のターゲットを選ぶように。
  - アクションボタン実装。
    - ロード後または`[awakegame]`を通るとゲーム変数`tyrano.plugin.kag.stat.f`が参照できなくなる仕様への対応のため、参照と書き込みは全て`TYRANO.kag.stat.f`を使うよう修正。
- ボイボ人狼用glinkボタンのCSS作成。
  - ボタンオブジェクトおよびボタンオブジェクトからglinkを生成するサブルーチン作成。
  - 他のボタンも順次デフォルトのglinkから切り替えたい。

## [0.4] - 2022-10-16
- サンプルゲームの方向性を決定。
  - キャラクター、メッセージマクロ、タイトル画面、フレームやボタン表示、フォント表示など実装（画像やフォントは非同梱）
- キャラクターの入退場マクロを作成。
- キャラクター選択ボタンへのマウスホバーでも入退場マクロを実行するようにした。

## [0.3] - 2022-08-20
- 議論フェイズ用アクションボタンの仮実装。呼び出し箇所は未作成。
- 視点の破綻後は、破綻したキャラの視点は共通視点オブジェクトで上書き、その他の視点は破綻したキャラを人狼陣営で更新するようにした。
  - プレイヤーの占い騙りによる破綻は未ブロック。扱いは同様でいいと思う。
- 人狼メニュー画面を作成。占いCO結果を一覧表示できるように。
  - 人狼メニュー画面から戻ってからゲームを進行するとエラーになるバグあり。
  - 「ステータス画面」に改称予定。
- 各キャラクターに信頼度オブジェクトを実装。
- 投票ロジック実装。

## [0.2] - 2021-07-04
- [messageマクロ](./data/scenario/messageMacros.ks)と[messageサブルーチン](data/scenario/message)にセリフやシステムメッセージを集約
- [playJinro.ks](./data/scenario/playJinro.ks)（scene1.ksから名称変更）をリファクタリング。キャラクターIDに依存していた処理をほぼ脱却
- PCの役職を選択できる画面を追加（将来のステージ選択機能の仮実装）

## [0.1] - 2021-06-27
- ある程度動いたところで初版公開

## TODOリスト
★：次にやるタスク
☆：やらないとアプデできないタスク
◎：やらないとリリースできないタスク
○：できればやりたいタスク
△：リリース後でいいタスク

- [ ] COフェイズ
  - [ ] 【○】現在のCO状況によって、未CO者のCOしたい度を変動させる(j_decideCOCandidateId)
  - [ ] 【△】CO時のセリフパターンの追加
    - [ ] 役職COと結果COで差分を付けられるようにする。（「自分が占い師だ」「昨日の占い結果は～」）
    - [ ] 役職COのとき、自分の前にCO済みの占い師がいる場合「自分こそが占い師だ」と主張することができるようにする
    - [ ] 結果COのとき、自分の前のCO結果によって反応を変えられるようにする（同じ相手を占った、違う相手を占った）
- [ ] 占い師の行動
  - [ ] 【○】ランダムではなく、一定の基準で占い先（騙りなら結果も）を決められるようにする(considerFortuneTellingTarget)
  - [ ] 【△】もし占い候補がいなければ（全員占い済みなら）占わないことができるようにする(determineFortuneTellingTargetId)
- [ ] NPCの思考と行動の雛形制作  
  - [ ] 【○】自分や仲間が破綻する騙りCOはしない
  - [ ] 【○】自分や仲間が破綻する襲撃はしない
- [ ] 議論フェイズの制作  
  - [ ] アクションオブジェクトや定数をリファクタする
  - [ ] 【○】「聞き出す」アクションの作成
  - [ ] 【△】アクションボタンの横に実行予定のアクションを表示する。「発言しない」や「Xを疑う」とフキダシ表示するイメージ
- [ ] 投票フェイズの制作  
  - [ ] 【○】各役職ごとの投票ロジックを作成する(decideVote)
  - [ ] 【○】追放後の反応セリフ作成、誰が言うかを決めるマクロを作成
- [ ] 【◎】ステータス画面作成
  - [ ] 【○】ステータス画面のキャラクターフキダシに、テーマカラーをグラデーションする
  - [ ] 【○】ステータス画面の投票履歴で被投票数を表示したり、最多得票者がわかるようにする（★をつけるか背景色を変えるか）
  - [ ] 【△】キャラクターBoxを順に表示しているが、最後まで生成しきってから揃って表示できるようにする
  - [ ] 【△】一括表示すると重くなるなら、投票履歴や占い履歴はボタンを押してから読み込むようにする
  - [ ] 【△】夜時間に表示するときは夜用のオブジェクトの方がよいか検討する
- [x] 【△】システムメッセージにもボイスを入れる→いらないと思う
- [x] 【☆】BGM、演出を入れる
- [ ] 【○】バックログ画面の作成
  - [ ] 【○】公式テンプレートからの脱却
- [x] 【○】投票画面の表示を初見でもわかりやすくする（→名前が投票先であること、背景色、★の意味）
- [ ] バグ修正
  - [ ] 【○】アクションの第二階層ボタンにマウスをホバーさせるたびに、ボタンが増殖することがある（シナリオを進めずにアクションボタンを繰り返し押すとなる？）
    - ボタン生成時のループ処理で、カウンターが勢い余ることがあるらしい。無限ループしないように`tf.cnt >= (tf.buttonCount - 1)`には修正したが根本原因の修正は未着手
      - おそらく、「ボタン表示時にカーソルが初めからボタンの位置にあると、hoverイベントが発生しないのでクラス名を取得できない」バグが第一階層のボタンで起きていたのではないか？そうなら上記のバグと同時に解消したと思われる。TODOはしばらく残しておく。
  - [ ] アクションの第二階層を開いたとき、黒いglinkボタンが表示されることがある（エラー文失念）
    - ひとつ上と同件？→これは今でもたまーに起きる
  - [ ] COフェイズ中にメニュー画面やステータス画面を開いて戻ると、同じキャラが再度COする
    - 少し試したが再現性なし？↓の修正をしたことで解消された？
  - [ ] 稀に変数格納が間に合わずundefinedと表示される（ティラノの仕様？）
    - 議論フェイズの発言候補者選択時、getCharacterIdByReliability()で発生するundefinedは実装バグだった。しばらくテストして再発しなければ解消とする。
  - [x] キャラがスライドインしてくる選択肢が出ている最中にステータス画面を開いて閉じると、スライドインや効果音が出なくなる
    - マウスオーバーメソッドの定義が、sleepgameを挟んだことで消えてしまった？
      - マウスオーバーメソッドは使わず、glinkボタン自体にenterseを埋め込んだことで解決。
- [x] 【◎】ゲームシナリオ作る
 - [x] 【☆】立ち位置左右を入れ分ける
 - [x] 【☆】立ち絵を入れる
 - [x] 【◎】ボイスを入れる
 - [x] 【◎】SE、BGM入れる
 - [x] 【◎】エンドロール作る
- [x] 【◎】遊びの部分を作る
  - [x] 【★】アチーブメント→アチーブメント機能ではなくなった
   - [x] 解放時にSEを入れる
- [ ] 【☆】コンフィグ画面作成
  - [ ] 【○】キャラ名の呼称テキストに、キャラのイメージカラーの下線を入れる（可能な限り全部入れる）
    - キャラ名の判別のため。このまま何も対策をしないと、No.7と春歌ナナを実装したときに判別がつかなくなる
- [ ] 【△】霊能者の実装（できれば）  
- [ ] 【△】狩人の実装（できれば）  
- [ ] NPCの思考の強化学習（マジで言ってんの？）  
- [ ] ファイル構成の再検討  
  - [ ] マクロ.ksに記載するのはどうしてもティラノで書かないといけない内容だけにし、ロジックは可能な限りjs内に移植する
- [ ] docsやコメントの補完  
- [ ] リファクタリング  
  - [ ] 【○】メソッド、マクロ、サブルーチン、クラスを適切なファイルに移動する
  - [ ] 【△】iscript内のコメントを//にする
- [ ] アクションオブジェクトに関して
  - [ ] 占い師のCO済み判定に使っているフラグisPublic（doneCOをアクションオブジェクト内に格納し名称変更）を、全てのアクションのオブジェクトに適用していく（公開情報ならtrueを入れるなど。議論履歴の表示可否判定にも使えるかもしれない）
- [ ] エラー調査用の実装
  - [ ] エラー発生時に全変数をファイル出力したい（ティラノ内にcatchしてる箇所がないか探す）
- [ ] 人狼プラグインからボイボ人狼依存のコードをなくす（サンプルになるコードが残るのは許容）
- [ ] プレイヤー退場後、「役職を公開する」ボタンをどこかに付ける（スキップは仕組み上厳しい）

and more....
