# シアター進捗段階関連の設計

シアターの進捗段階とそれに関わるシステムやステータス、条件の設計を行う。

# 目次
- [エピソード解放ステータス](#エピソード解放ステータス)
  - [0：導入編未解放かつ現時点では解放不可](#0導入編未解放かつ現時点では解放不可)
  - [1：導入編未解放かつ解放可](#1導入編未解放かつ解放可)
  - [2：導入編解放済みで解決編未解放](#2導入編解放済みで解決編未解放)
  - [3：解決編まで解放済み](#3解決編まで解放済み)
- [シチュエーション開始条件とシチュエーション完遂条件](#シチュエーション開始条件とシチュエーション完遂条件)
  - [シチュエーション開始条件](#シチュエーション開始条件)
  - [シチュエーション完遂条件](#シチュエーション完遂条件)
- [シアター進捗段階](#シアター進捗段階)
  - [1. 初回起動時](#1-初回起動時)
  - [2. チュートリアル未クリア時](#2-チュートリアル未クリア時)
  - [3. チュートリアルクリア後](#3-チュートリアルクリア後)
  - [4. 第8話解放後](#4-第8話解放後)
  - [5. 第1章クリア後（第2章公開前）](#5-第1章クリア後第2章公開前)
- [人狼ゲーム開始時、終了時の処理設計](#人狼ゲーム開始時終了時の処理設計)
  - [シチュエーション開始チェック](#シチュエーション開始チェック)
  - [シチュエーション開始条件に合致したかのチェック](#シチュエーション開始条件に合致したかのチェック)
  - [シチュエーション完遂チェック](#シチュエーション完遂チェック)


# エピソード解放ステータス

- 各エピソード（導入編と解決編をひとまとめにした言い方）ごとにそれぞれ設定されている
- 初期状態は0で、シアターの進捗段階に応じてやシチュエーション開始条件、完遂条件を満たすことでステータスが遷移していく

## 0：導入編未解放かつ現時点では解放不可
- シアター画面上は砂嵐画像、タイトルは「？？？？？」
- シチュエーション開始条件に合致する人狼ゲームデータでゲームを開始しても、1に遷移しない

## 1：導入編未解放かつ解放可
- シアター画面上はサムネ画像、タイトルはそのエピソードのもの
- エピソードウィンドウには「シチュエーション」のみ表示
- シチュエーション開始条件に合致する人狼ゲームデータでゲームを開始すると、導入編が自動再生され、2に遷移する

## 2：導入編解放済みで解決編未解放
- シアター画面上はサムネ画像、タイトルはそのエピソードのもの、銀枠つき
- エピソードウィンドウには「導入編を見る」「シチュエーション」が表示
- シチュエーション開始条件に合致する人狼ゲームデータでゲームを開始しても、導入編は自動再生しない
- シチュエーション完遂条件を満たしてゲームを終了すると、解決編が自動再生され、3に遷移する
    - 1から2に遷移したばかりのゲームで完遂条件を満たした場合も同様

## 3：解決編まで解放済み
- シアター画面上はサムネ画像、タイトルはそのエピソードのもの、金枠つき
- エピソードウィンドウには「導入編を見る」「解決編を見る」が表示
- シチュエーション開始条件、完遂条件を満たしても何も起こらない



# シチュエーション開始条件とシチュエーション完遂条件
- 各エピソードごとにそれぞれ設定されている
- エピソードウィンドウに「シチュエーション」として簡潔な文章で表示しておく

## シチュエーション開始条件
- 今までの「このシチュエーションでプレイする」で設定していた開始条件のこと
- 以下のような条件がある
    - プレイヤーキャラクター条件
    - 不参加キャラ条件
    - 参加人数条件
    - 参加キャラの役職条件
- 以下を全て満たすと、ゲーム開始時に導入編を自動再生し、エピソード解放ステータスを「2：導入編解放済みで解決編未解放」に遷移する
    - 現在のエピソード解放ステータスが「1：導入編未解放かつ解放可」である
    - 開始条件を満たしてゲームを開始した（すでに「2：導入編解放済みで解決編未解放」であっても開始条件のチェックはすること）

## シチュエーション完遂条件
- 以下のような条件がある
    - ゲームに勝利する
    - 人狼陣営が全滅した状態でゲームに敗北する
- 以下を全て満たすと、ゲーム終了時に解決編を自動再生し、エピソード解放ステータスを「3：解決編まで解放済み」に遷移する
    - 現在のエピソード解放ステータスが「2：導入編解放済みで解決編未解放」である
    - 開始条件を満たしてゲームを開始した
    - 完遂条件を満たしてゲームを終了した



# シアター進捗段階

シアターの進捗段階（ゲームのシナリオの進捗状況と同義）を大まかに区切ると以下の通りとなる。

実装上では全シアターのエピソード解放ステータスを格納したオブジェクトを参照することで、現在どの段階にあるかを判定する。

## 1. 初回起動時
- 定義
    - 第1話「誰がずんだもちを食べたのだ？」の解放ステータス=1
    - 第2話～第7話の解放ステータス=0
    - 第8話「誰が人狼ゲームを始めたのだ？」の解放ステータス=0
- タイトル画面のボタン
    - 「プレイスタート」「コンフィグ」のみ
- 特殊な挙動
    - 「プレイスタート」時
        - 必ず第1話用の人狼ゲームデータでゲーム開始する
        - ゲーム中、チュートリアル（初回起動用）の会話が逐次差し挟まれる
    - チュートリアルで勝利する
        - 第1話解決編を自動再生し、解放ステータス=3に遷移（通常通りの挙動）
        - 第2話～第7話の解放ステータス=1に遷移
            - すなわち「3. チュートリアルクリア後」の段階に進む
    - チュートリアルで敗北する
        - 敗北用の会話発生
            - すなわち「2. チュートリアル未クリア時」の段階に進む
    - チュートリアルで引き分けになる
        - 引き分け用の会話発生
            - すなわち「2. チュートリアル未クリア時」の段階に進む

## 2. チュートリアル未クリア時
- 定義
    - 第1話の解放ステータス=2
    - 第2話～第7話の解放ステータス=0
    - 第8話の解放ステータス=0
        - すなわち、チュートリアルで敗北または引き分け後のこと
- タイトル画面のボタン
    - 「プレイスタート」「コンフィグ」のみ
- 特殊な挙動
    - 「プレイスタート」時
        - 必ず第1話用の人狼ゲームデータでゲーム開始する
        - ゲーム中、チュートリアル（2回目以降用）の会話が逐次差し挟まれる
     - ゲーム終了時の挙動は「1. 初回起動時」と同様

TODO：任意のタイミングでチュートリアルを見たい場合にどうするか

## 3. チュートリアルクリア後
- 定義
    - 第1話の解放ステータス=3
    - 第2話～第7話の解放ステータス=1～3
    - 第8話の解放ステータス=0
        - すなわち、チュートリアルで勝利後のこと
- タイトル画面のボタン
    - 「プレイスタート」「シアター」「カスタマイズ」「コンフィグ」
- 特殊な挙動
    - ゲーム終了時、第2話～第7話の解放ステータスが全て3になったなら、第8話の解放ステータスを1に遷移
        - すなわち「4. 第8話解放後」の段階に進む

## 4. 第8話解放後
- 定義
    - 第1話の解放ステータス=3
    - 第2話～第7話の解放ステータス=3
    - 第8話の解放ステータス=1～2
- タイトル画面のボタン
    - 「プレイスタート」「シアター」「カスタマイズ」「コンフィグ」
- 特殊な挙動
    - 特になし

## 5. 第1章クリア後（第2章公開前）
- 定義
    - 第1話の解放ステータス=3
    - 第2話～第7話の解放ステータス=3
    - 第8話の解放ステータス=3
- タイトル画面のボタン
    - 「プレイスタート」「シアター」「カスタマイズ」「コンフィグ」
- 特殊な挙動
    - 「カスタマイズ」内でプレイヤーキャラを選択可能になる



# 人狼ゲーム開始時、終了時の処理設計

参考：[人狼ゲームデータ](人狼ゲームデータ.md)

## シチュエーション開始チェック
人狼ゲームの「プレイスタート」時、人狼ゲームデータを読み込んだタイミング（役職割り振りなどの事前準備を行う前）で以下の処理を行う。

1. 現在、解放ステータス=1のエピソードが1つ以上ある
2. 解放ステータス=1のエピソードと現在の人狼ゲームデータを比べて、シチュエーション開始条件に合致（後述）した

以上を全て満たした場合、以下の処理を行う。

- 合致したエピソードの導入編を自動再生し、解放ステータスを「2：導入編解放済みで解決編未解放」に遷移する
- シチュエーション開始変数にそのエピソード名を格納する

それを満たさなかった場合、次に以下をチェックする。

1. 解放ステータス=1のエピソードがないかつ、解放ステータス=2のエピソードが1つ以上ある
2. 解放ステータス=2のエピソードと現在の人狼ゲームデータを比べて、シチュエーション開始条件に合致（後述）した

以上を全て満たした場合、以下の処理を行う。

- シチュエーション開始変数にそのエピソード名を格納する

以上の処理が終了したら、役職割り振りなどの事前準備を行ってから人狼ゲームを開始する。

## シチュエーション開始条件に合致したかのチェック

「シチュエーション開始チェック」の2.の判定の中で行っている処理を詳述する。

以下全てのチェックにおいて、チェック対象エピソード側で特に条件指定されていなければその条件のチェックは不要とする。

1. チェック対象エピソード側で指定されているプレイヤーキャラと、現在の人狼ゲームデータ側のプレイヤーキャラが一致していること
2. チェック対象エピソード側で不参加であることが条件のキャラが、現在の人狼ゲームデータ側の参加ステータスが「不参加」or「参加候補」であること
    1. そのキャラの参加ステータスが「参加候補」なら「不参加」に更新する
4. 以下の役職チェックでNGにならないこと
    1. チェック対象エピソード側で役職（複数候補ある場合もある）が指定されているキャラについて
        1. 現在の人狼ゲームデータ側で役職がランダムであるなら、
            1. 現在の人狼ゲームデータ側でその役職（複数候補ある場合は候補役職全て）の残り人数を取得する
            2. （候補役職全ての）残り人数が0の場合は、チェックNGで終了
            3. 残り人数が1以上残っている役職が1つならそれで（複数あるならその中からランダムで選択し）そのキャラの役職を確定させる
        2. 現在の人狼ゲームデータ側でその役職以外で指定済みの場合は、チェックNGで終了（ランダムは前項で潰し済みなので判定時には考慮不要）
        3. 現在の人狼ゲームデータ側で参加ステータスが「参加候補」であるなら、「参加確定」させる
    2. チェック対象エピソード側で役職は指定されていないが、参加指定されているキャラについて
        1. 現在の人狼ゲームデータ側で参加ステータスが「参加候補」であるなら、「参加確定」させる
3. 以下の参加人数チェックを行い、全ての条件を満たすこと
    1. 現在の人狼ゲームデータ側で参加ステータスが「参加確定」であるキャラ数 <= チェック対象エピソード側で参加指定されているキャラ数
    2. チェック対象エピソード側で参加指定されているキャラ数 <= 現在の人狼ゲームデータ側で参加ステータスが「参加確定」または「参加候補」であるキャラ数
        1. ※要するに、「参加確定」のキャラが余ってしまうのはNGだし、「参加候補」のキャラを加えても人数不足な場合もNGという意味

以上全てのチェックを全て満たした場合、「シチュエーション開始条件に合致した」とみなしてそのエピソードで開始することを確定する。

1つでもチェックを満たさなかった場合、次のエピソードのシチュエーション開始チェックに移る。

## シチュエーション完遂チェック

人狼ゲームの終了時、結果発表画面表示の直後のタイミングで以下の処理を行う。

1. シチュエーション開始変数にエピソードが格納されている
2. そのエピソードのシチュエーション完遂条件を満たしてゲーム終了した

以上を全て満たした場合、以下の処理を行う。

- そのエピソードの解決編を自動再生し、解放ステータスを「3：解決編まで解放済み」に遷移する

以上の処理が終了したら、タイトル画面に戻る。
